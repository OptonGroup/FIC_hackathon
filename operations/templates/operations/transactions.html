{% extends 'base_operations.html' %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок и кнопка добавления -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Транзакции</h2>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
            <i class="bi bi-plus-lg me-2"></i>Добавить транзакцию
        </button>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <form class="row g-3" id="filterForm">
                <div class="col-md-3">
                    <label class="form-label">Тип</label>
                    <select class="form-select" name="type" id="typeFilter">
                        <option value="">Все типы</option>
                        <option value="income" {% if selected_type == 'income' %}selected{% endif %}>Доход</option>
                        <option value="expense" {% if selected_type == 'expense' %}selected{% endif %}>Расход</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Категория</label>
                    <select class="form-select" name="category" id="categoryFilter">
                        <option value="">Все категории</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Карта</label>
                    <select class="form-select" name="card" id="cardFilter">
                        <option value="">Все карты</option>
                        {% for card in cards %}
                        <option value="{{ card.id }}" {% if selected_card == card.id %}selected{% endif %}>
                            {{ card.name }} ({{ card.bank }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Дата от</label>
                    <input type="date" class="form-control" name="date_from" id="dateFromFilter" value="{{ selected_date_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Дата до</label>
                    <input type="date" class="form-control" name="date_to" id="dateToFilter" value="{{ selected_date_to }}">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-secondary">
                        <i class="bi bi-funnel me-2"></i>Применить фильтры
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                        <i class="bi bi-x-circle me-2"></i>Сбросить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Список транзакций -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a href="?{% if request.GET.sort == 'date' and not request.GET.desc %}sort=date&desc=1{% else %}sort=date{% endif %}" class="text-dark text-decoration-none">
                                    Дата
                                    <i class="bi bi-arrow-{% if request.GET.sort == 'date' and request.GET.desc %}down{% elif request.GET.sort == 'date' or request.GET.sort == None %}up{% else %}down{% endif %}"></i>
                                </a>
                            </th>
                            <th>
                                <a href="?{% if request.GET.sort == 'type' and not request.GET.desc %}sort=type&desc=1{% else %}sort=type{% endif %}" class="text-dark text-decoration-none">
                                    Тип
                                    <i class="bi bi-arrow-{% if request.GET.sort == 'type' and request.GET.desc %}down{% else %}up{% endif %}"></i>
                                </a>
                            </th>
                            <th>
                                <a href="?{% if request.GET.sort == 'card' and not request.GET.desc %}sort=card&desc=1{% else %}sort=card{% endif %}" class="text-dark text-decoration-none">
                                    Карта
                                    <i class="bi bi-arrow-{% if request.GET.sort == 'card' and request.GET.desc %}down{% else %}up{% endif %}"></i>
                                </a>
                            </th>
                            <th>
                                <a href="?{% if request.GET.sort == 'category' and not request.GET.desc %}sort=category&desc=1{% else %}sort=category{% endif %}" class="text-dark text-decoration-none">
                                    Категория
                                    <i class="bi bi-arrow-{% if request.GET.sort == 'category' and request.GET.desc %}down{% else %}up{% endif %}"></i>
                                </a>
                            </th>
                            <th>Описание</th>
                            <th>
                                <a href="?{% if request.GET.sort == 'amount' and not request.GET.desc %}sort=amount&desc=1{% else %}sort=amount{% endif %}" class="text-dark text-decoration-none">
                                    Сумма
                                    <i class="bi bi-arrow-{% if request.GET.sort == 'amount' and request.GET.desc %}down{% else %}up{% endif %}"></i>
                                </a>
                            </th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.date|date:"d.m.Y" }}</td>
                            <td>
                                <span class="badge {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ transaction.get_type_display }}
                                </span>
                            </td>
                            <td>
                                {% if transaction.card %}
                                <div class="card-preview-mini d-inline-flex align-items-center p-2 rounded-2 
                                    {% if transaction.card.design == 'classic_black' %}bg-dark text-white
                                    {% elif transaction.card.design == 'classic_white' %}bg-white text-dark border
                                    {% elif transaction.card.design == 'gold' %}bg-warning text-dark
                                    {% elif transaction.card.design == 'platinum' %}bg-secondary text-white
                                    {% elif transaction.card.design == 'metal' %}bg-light text-dark border
                                    {% else %}bg-white text-dark border{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="bi {% if transaction.card.card_type == 'credit' %}bi-credit-card{% else %}bi-credit-card-2-front{% endif %} me-2"></i>
                                        <div>
                                            <small class="d-block lh-1">{{ transaction.card.name }}</small>
                                            <small class="d-block text-opacity-75">{{ transaction.card.bank }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-muted">Карта не указана</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge" style="background-color: {{ transaction.category.color }}">
                                    <i class="bi {{ transaction.category.icon }} me-1"></i>
                                    {{ transaction.category.name }}
                                </span>
                            </td>
                            <td>{{ transaction.description|default:"-" }}</td>
                            <td>
                                <span class="{% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                    {% if transaction.type == 'income' %}+{% else %}-{% endif %}
                                    {{ transaction.amount|floatformat:2 }} ₽
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editTransactionModal{{ transaction.id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#deleteTransactionModal{{ transaction.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>

                        <!-- Модальное окно редактирования -->
                        <div class="modal fade" id="editTransactionModal{{ transaction.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Редактировать транзакцию</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'operations:edit_transaction' transaction.id %}">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Тип</label>
                                                <select class="form-select transaction-type" name="type" required>
                                                    <option value="income" {% if transaction.type == 'income' %}selected{% endif %}>Доход</option>
                                                    <option value="expense" {% if transaction.type == 'expense' %}selected{% endif %}>Расход</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Категория</label>
                                                <select class="form-select category-select" name="category" required>
                                                    {% for category in categories %}
                                                    <option value="{{ category.id }}" 
                                                            data-type="{{ category.type }}"
                                                            {% if category.id == transaction.category.id %}selected{% endif %}>
                                                        {{ category.name }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Сумма</label>
                                                <input type="number" class="form-control" name="amount" value="{{ transaction.amount }}" required step="0.01">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Описание</label>
                                                <textarea class="form-control" name="description" rows="3">{{ transaction.description }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Дата</label>
                                                <input type="date" class="form-control" name="date" value="{{ transaction.date|date:'Y-m-d' }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Карта</label>
                                                <select class="form-select" name="card" required>
                                                    {% for card in cards %}
                                                    <option value="{{ card.id }}" {% if transaction.card.id == card.id %}selected{% endif %}>
                                                        {{ card.name }} ({{ card.bank }}) - {{ card.get_masked_number }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                                            <button type="submit" class="btn btn-dark">Сохранить</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Модальное окно удаления -->
                        <div class="modal fade" id="deleteTransactionModal{{ transaction.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Удалить транзакцию</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Вы уверены, что хотите удалить эту транзакцию?</p>
                                        <p class="mb-0"><strong>Дата:</strong> {{ transaction.date|date:"d.m.Y" }}</p>
                                        <p class="mb-0"><strong>Тип:</strong> {{ transaction.get_type_display }}</p>
                                        <p class="mb-0"><strong>Сумма:</strong> {{ transaction.amount }} ₽</p>
                                    </div>
                                    <form method="post" action="{% url 'operations:delete_transaction' transaction.id %}">
                                        {% csrf_token %}
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                                            <button type="submit" class="btn btn-dark">Удалить</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <p class="text-muted mb-0">Транзакции не найдены</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления транзакции -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить транзакцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'operations:add_transaction' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Карта</label>
                        <select class="form-select" name="card" required>
                            {% for card in cards %}
                            <option value="{{ card.id }}">
                                <div class="d-flex align-items-center">
                                    {{ card.name }} ({{ card.bank }}) - {{ card.get_masked_number }}
                                </div>
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" name="type" id="transactionType" required>
                            <option value="income">Доход</option>
                            <option value="expense">Расход</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        <select class="form-select" name="category" id="categorySelect" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    data-type="{{ category.type }}"
                                    {% if category.type != 'both' and category.type != 'income' %}style="display:none"{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input type="number" class="form-control" name="amount" required step="0.01">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .card-preview-mini {
        font-size: 0.875rem;
        min-width: 200px;
        transition: all 0.2s ease-in-out;
    }
    
    .card-preview-mini:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .text-opacity-75 {
        opacity: 0.75;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик кнопки сброса
    document.getElementById('resetFilters').addEventListener('click', function() {
        // Очищаем все поля фильтров
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('cardFilter').value = '';
        document.getElementById('dateFromFilter').value = '';
        document.getElementById('dateToFilter').value = '';
        
        // Автоматически отправляем форму
        document.getElementById('filterForm').submit();
    });
    
    // Остальной JavaScript код для работы с категориями
    const transactionType = document.getElementById('transactionType');
    const categorySelect = document.getElementById('categorySelect');
    
    function updateCategories() {
        const selectedType = transactionType.value;
        const options = categorySelect.options;
        
        for (let option of options) {
            const categoryType = option.dataset.type;
            if (categoryType === 'both' || categoryType === selectedType) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        }
        
        // Выбираем первую видимую опцию
        for (let option of options) {
            if (option.style.display !== 'none') {
                categorySelect.value = option.value;
                break;
            }
        }
    }
    
    if (transactionType && categorySelect) {
        transactionType.addEventListener('change', updateCategories);
        updateCategories();
    }
});
</script>
{% endblock %}